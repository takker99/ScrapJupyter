// deno-fmt-ignore-file
// deno-lint-ignore-file
const Ge=e=>e.toLowerCase().replaceAll(" ","_").replace(/[/?#\{}^|<>]/g,t=>encodeURIComponent(t));function He(){return(scrapbox.Page.lines?.flatMap(t=>"codeBlock"in t?[t]:[])??[]).reduce((t,{codeBlock:r,text:i,id:s})=>{const l=t.findIndex(({filename:o})=>o!==void 0&&o===r.filename);return r.start&&l<0?[...t,{filename:r.filename,dir:`https://scrpabox.io/api/code/${scrapbox.Project.name}/${Ge(scrapbox.Page.title??"")}`,lang:r.lang,startIds:[s],lines:[]}]:(r.start?t.at(l)?.startIds?.push?.(s):t.at(l)?.lines?.push?.(i),t)},[])}function Ae(e){let t=i=>{if(i===null)r.write8(0);else if(typeof i=="boolean")r.write8(1),r.write8(+i);else if(typeof i=="number")r.write8(2),r.write32(i|0);else if(typeof i=="string")r.write8(3),r.write(fe(i));else if(i instanceof Uint8Array)r.write8(4),r.write(i);else if(i instanceof Array){r.write8(5),r.write32(i.length);for(let s of i)t(s)}else{let s=Object.keys(i);r.write8(6),r.write32(s.length);for(let l of s)r.write(fe(l)),t(i[l])}},r=new Ce;return r.write32(0),r.write32(e.id<<1|+!e.isRequest),t(e.value),Re(r.buf,r.len-4,0),r.buf.subarray(0,r.len)}function Qe(e){let t=()=>{switch(r.read8()){case 0:return null;case 1:return!!r.read8();case 2:return r.read32();case 3:return be(r.read());case 4:return r.read();case 5:{let o=r.read32(),a=[];for(let b=0;b<o;b++)a.push(t());return a}case 6:{let o=r.read32(),a={};for(let b=0;b<o;b++)a[be(r.read())]=t();return a}default:throw new Error("Invalid packet")}},r=new Ce(e),i=r.read32(),s=(i&1)==0;i>>>=1;let l=t();if(r.ptr!==e.length)throw new Error("Invalid packet");return{id:i,isRequest:s,value:l}}class Ce{buf;len=0;ptr=0;constructor(t=new Uint8Array(1024)){this.buf=t}_write(t){if(this.len+t>this.buf.length){let r=new Uint8Array((this.len+t)*2);r.set(this.buf),this.buf=r}return this.len+=t,this.len-t}write8(t){let r=this._write(1);this.buf[r]=t}write32(t){let r=this._write(4);Re(this.buf,t,r)}write(t){let r=this._write(4+t.length);Re(this.buf,t.length,r),this.buf.set(t,r+4)}_read(t){if(this.ptr+t>this.buf.length)throw new Error("Invalid packet");return this.ptr+=t,this.ptr-t}read8(){return this.buf[this._read(1)]}read32(){return Ne(this.buf,this._read(4))}read(){let t=this.read32(),r=new Uint8Array(t),i=this._read(r.length);return r.set(this.buf.subarray(i,i+t)),r}}let fe,be;if(typeof TextEncoder!="undefined"&&typeof TextDecoder!="undefined"){let e=new TextEncoder,t=new TextDecoder;fe=r=>e.encode(r),be=r=>t.decode(r)}else throw new Error("No UTF-8 codec found");function Ne(e,t){return e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24}function Re(e,t,r){e[r++]=t,e[r++]=t>>8,e[r++]=t>>16,e[r++]=t>>24}const Ie="0.12.25";function Pe(e){if(e+="",e.indexOf(",")>=0)throw new Error(`Invalid target: ${e}`);return e}let De=()=>null,W=e=>typeof e=="boolean"?null:"a boolean",Xe=e=>typeof e=="boolean"||typeof e=="object"&&!Array.isArray(e)?null:"a boolean or an object",p=e=>typeof e=="string"?null:"a string",Be=e=>e instanceof RegExp?null:"a RegExp object",de=e=>typeof e=="number"&&e===(e|0)?null:"an integer",Le=e=>typeof e=="function"?null:"a function",J=e=>Array.isArray(e)?null:"an array",he=e=>typeof e=="object"&&e!==null&&!Array.isArray(e)?null:"an object",Ze=e=>typeof e=="object"&&e!==null?null:"an array or an object",Ue=e=>typeof e=="object"&&!Array.isArray(e)?null:"an object or null",Oe=e=>typeof e=="string"||typeof e=="boolean"?null:"a string or a boolean",qe=e=>typeof e=="string"||typeof e=="object"&&e!==null&&!Array.isArray(e)?null:"a string or an object",et=e=>typeof e=="string"||Array.isArray(e)?null:"a string or an array",tt=e=>typeof e=="string"||e instanceof Uint8Array?null:"a string or a Uint8Array";function n(e,t,r,i){let s=e[r];if(t[r+""]=!0,s===void 0)return;let l=i(s);if(l!==null)throw new Error(`"${r}" must be ${l}`);return s}function K(e,t,r){for(let i in e)if(!(i in t))throw new Error(`Invalid option ${r}: "${i}"`)}function rt(e){let t=Object.create(null),r=n(e,t,"wasmURL",p),i=n(e,t,"workerURL",p),s=n(e,t,"worker",W);return K(e,t,"in startService() call"),{wasmURL:r,workerURL:i,worker:s}}function xe(e,t,r,i,s){let l=n(t,r,"color",W),o=n(t,r,"logLevel",p),a=n(t,r,"logLimit",de);l!==void 0?e.push(`--color=${l}`):i&&e.push("--color=true"),e.push(`--log-level=${o||s}`),e.push(`--log-limit=${a||0}`)}function Me(e,t,r){let i=n(t,r,"legalComments",p),s=n(t,r,"sourceRoot",p),l=n(t,r,"sourcesContent",W),o=n(t,r,"target",et),a=n(t,r,"format",p),b=n(t,r,"globalName",p),k=n(t,r,"minify",W),j=n(t,r,"minifySyntax",W),F=n(t,r,"minifyWhitespace",W),_=n(t,r,"minifyIdentifiers",W),R=n(t,r,"charset",p),P=n(t,r,"treeShaking",Oe),ee=n(t,r,"jsx",p),X=n(t,r,"jsxFactory",p),re=n(t,r,"jsxFragment",p),te=n(t,r,"define",he),ae=n(t,r,"pure",J),oe=n(t,r,"keepNames",W);if(i&&e.push(`--legal-comments=${i}`),s!==void 0&&e.push(`--source-root=${s}`),l!==void 0&&e.push(`--sources-content=${l}`),o&&(Array.isArray(o)?e.push(`--target=${Array.from(o).map(Pe).join(",")}`):e.push(`--target=${Pe(o)}`)),a&&e.push(`--format=${a}`),b&&e.push(`--global-name=${b}`),k&&e.push("--minify"),j&&e.push("--minify-syntax"),F&&e.push("--minify-whitespace"),_&&e.push("--minify-identifiers"),R&&e.push(`--charset=${R}`),P!==void 0&&P!==!0&&e.push(`--tree-shaking=${P}`),ee&&e.push(`--jsx=${ee}`),X&&e.push(`--jsx-factory=${X}`),re&&e.push(`--jsx-fragment=${re}`),te)for(let H in te){if(H.indexOf("=")>=0)throw new Error(`Invalid define: ${H}`);e.push(`--define:${H}=${te[H]}`)}if(ae)for(let H of ae)e.push(`--pure:${H}`);oe&&e.push("--keep-names")}function nt(e,t,r,i,s){let l=[],o=[],a=Object.create(null),b=null,k=null,j=null;xe(l,t,a,r,i),Me(l,t,a);let F=n(t,a,"sourcemap",Oe),_=n(t,a,"bundle",W),R=n(t,a,"watch",Xe),P=n(t,a,"splitting",W),ee=n(t,a,"preserveSymlinks",W),X=n(t,a,"metafile",W),re=n(t,a,"outfile",p),te=n(t,a,"outdir",p),ae=n(t,a,"outbase",p),oe=n(t,a,"platform",p),H=n(t,a,"tsconfig",p),ve=n(t,a,"resolveExtensions",J),ye=n(t,a,"nodePaths",J),Ee=n(t,a,"mainFields",J),Se=n(t,a,"conditions",J),h=n(t,a,"external",J),f=n(t,a,"loader",he),c=n(t,a,"outExtension",he),w=n(t,a,"publicPath",p),B=n(t,a,"entryNames",p),C=n(t,a,"chunkNames",p),T=n(t,a,"assetNames",p),I=n(t,a,"inject",J),O=n(t,a,"banner",he),L=n(t,a,"footer",he),x=n(t,a,"entryPoints",Ze),N=n(t,a,"absWorkingDir",p),E=n(t,a,"stdin",he),$=n(t,a,"write",W)??s,S=n(t,a,"allowOverwrite",W),m=n(t,a,"incremental",W)===!0;if(a.plugins=!0,K(t,a,`in ${e}() call`),F&&l.push(`--sourcemap${F===!0?"":`=${F}`}`),_&&l.push("--bundle"),S&&l.push("--allow-overwrite"),R)if(l.push("--watch"),typeof R=="boolean")j={};else{let u=Object.create(null),g=n(R,u,"onRebuild",Le);K(R,u,`on "watch" in ${e}() call`),j={onRebuild:g}}if(P&&l.push("--splitting"),ee&&l.push("--preserve-symlinks"),X&&l.push("--metafile"),re&&l.push(`--outfile=${re}`),te&&l.push(`--outdir=${te}`),ae&&l.push(`--outbase=${ae}`),oe&&l.push(`--platform=${oe}`),H&&l.push(`--tsconfig=${H}`),ve){let u=[];for(let g of ve){if(g+="",g.indexOf(",")>=0)throw new Error(`Invalid resolve extension: ${g}`);u.push(g)}l.push(`--resolve-extensions=${u.join(",")}`)}if(w&&l.push(`--public-path=${w}`),B&&l.push(`--entry-names=${B}`),C&&l.push(`--chunk-names=${C}`),T&&l.push(`--asset-names=${T}`),Ee){let u=[];for(let g of Ee){if(g+="",g.indexOf(",")>=0)throw new Error(`Invalid main field: ${g}`);u.push(g)}l.push(`--main-fields=${u.join(",")}`)}if(Se){let u=[];for(let g of Se){if(g+="",g.indexOf(",")>=0)throw new Error(`Invalid condition: ${g}`);u.push(g)}l.push(`--conditions=${u.join(",")}`)}if(h)for(let u of h)l.push(`--external:${u}`);if(O)for(let u in O){if(u.indexOf("=")>=0)throw new Error(`Invalid banner file type: ${u}`);l.push(`--banner:${u}=${O[u]}`)}if(L)for(let u in L){if(u.indexOf("=")>=0)throw new Error(`Invalid footer file type: ${u}`);l.push(`--footer:${u}=${L[u]}`)}if(I)for(let u of I)l.push(`--inject:${u}`);if(f)for(let u in f){if(u.indexOf("=")>=0)throw new Error(`Invalid loader extension: ${u}`);l.push(`--loader:${u}=${f[u]}`)}if(c)for(let u in c){if(u.indexOf("=")>=0)throw new Error(`Invalid out extension: ${u}`);l.push(`--out-extension:${u}=${c[u]}`)}if(x)if(Array.isArray(x))for(let u of x)o.push(["",u+""]);else for(let[u,g]of Object.entries(x))o.push([u+"",g+""]);if(E){let u=Object.create(null),g=n(E,u,"contents",p),D=n(E,u,"resolveDir",p),d=n(E,u,"sourcefile",p),v=n(E,u,"loader",p);K(E,u,'in "stdin" object'),d&&l.push(`--sourcefile=${d}`),v&&l.push(`--loader=${v}`),D&&(k=D+""),b=g?g+"":""}let y=[];if(ye)for(let u of ye)u+="",y.push(u);return{entries:o,flags:l,write:$,stdinContents:b,stdinResolveDir:k,absWorkingDir:N,incremental:m,nodePaths:y,watch:j}}function lt(e,t,r,i){let s=[],l=Object.create(null);xe(s,t,l,r,i),Me(s,t,l);let o=n(t,l,"sourcemap",Oe),a=n(t,l,"tsconfigRaw",qe),b=n(t,l,"sourcefile",p),k=n(t,l,"loader",p),j=n(t,l,"banner",p),F=n(t,l,"footer",p);return K(t,l,`in ${e}() call`),o&&s.push(`--sourcemap=${o===!0?"external":o}`),a&&s.push(`--tsconfig-raw=${typeof a=="string"?a:JSON.stringify(a)}`),b&&s.push(`--sourcefile=${b}`),k&&s.push(`--loader=${k}`),j&&s.push(`--banner=${j}`),F&&s.push(`--footer=${F}`),s}function it(e){let t=new Map,r=new Map,i=new Map,s=new Map,l=0,o=!1,a=0,b=0,k=new Uint8Array(16*1024),j=0,F=h=>{let f=j+h.length;if(f>k.length){let w=new Uint8Array(f*2);w.set(k),k=w}k.set(h,j),j+=h.length;let c=0;for(;c+4<=j;){let w=Ne(k,c);if(c+4+w>j)break;c+=4,re(k.subarray(c,c+w)),c+=w}c>0&&(k.copyWithin(0,c,j),j-=c)},_=()=>{o=!0;for(let h of t.values())h("The service was stopped",null);t.clear();for(let h of s.values())h.onWait("The service was stopped");s.clear();for(let h of i.values())try{h(new Error("The service was stopped"),null)}catch(f){console.error(f)}i.clear()},R=(h,f,c)=>{if(o)return c("The service is no longer running",null);let w=a++;t.set(w,(B,C)=>{try{c(B,C)}finally{h&&h.unref()}}),h&&h.ref(),e.writeToStdin(Ae({id:w,isRequest:!0,value:f}))},P=(h,f)=>{if(o)throw new Error("The service is no longer running");e.writeToStdin(Ae({id:h,isRequest:!1,value:f}))},ee=async(h,f)=>{try{switch(f.command){case"ping":{P(h,{});break}case"start":{let c=r.get(f.key);c?P(h,await c(f)):P(h,{});break}case"resolve":{let c=r.get(f.key);c?P(h,await c(f)):P(h,{});break}case"load":{let c=r.get(f.key);c?P(h,await c(f)):P(h,{});break}case"serve-request":{let c=s.get(f.serveID);c&&c.onRequest&&c.onRequest(f.args),P(h,{});break}case"serve-wait":{let c=s.get(f.serveID);c&&c.onWait(f.error),P(h,{});break}case"watch-rebuild":{let c=i.get(f.watchID);try{c&&c(null,f.args)}catch(w){console.error(w)}P(h,{});break}default:throw new Error("Invalid command: "+f.command)}}catch(c){P(h,{errors:[we(c,e,null,void 0,"")]})}},X=!0,re=h=>{if(X){X=!1;let c=String.fromCharCode(...h);if(c!==Ie)throw new Error(`Cannot start service: Host version "${Ie}" does not match binary version ${JSON.stringify(c)}`);return}let f=Qe(h);if(f.isRequest)ee(f.id,f.value);else{let c=t.get(f.id);t.delete(f.id),f.value.error?c(f.value.error,{}):c(null,f.value)}},te=async(h,f,c,w)=>{let B=[],C=[],T={},I={},O=0,L=0,x=[];f=[...f];for(let S of f){let m={};if(typeof S!="object")throw new Error(`Plugin at index ${L} must be an object`);let y=n(S,m,"name",p);if(typeof y!="string"||y==="")throw new Error(`Plugin at index ${L} is missing a name`);try{let u=n(S,m,"setup",Le);if(typeof u!="function")throw new Error("Plugin is missing a setup function");K(S,m,`on plugin ${JSON.stringify(y)}`);let g={name:y,onResolve:[],onLoad:[]};L++;let D=u({initialOptions:h,onStart(d){let v='This error came from the "onStart" callback registered here',M=ke(new Error(v),e,"onStart");B.push({name:y,callback:d,note:M})},onEnd(d){let v='This error came from the "onEnd" callback registered here',M=ke(new Error(v),e,"onEnd");C.push({name:y,callback:d,note:M})},onResolve(d,v){let M='This error came from the "onResolve" callback registered here',U=ke(new Error(M),e,"onResolve"),z={},V=n(d,z,"filter",Be),G=n(d,z,"namespace",p);if(K(d,z,`in onResolve() call for plugin ${JSON.stringify(y)}`),V==null)throw new Error("onResolve() call is missing a filter");let Y=O++;T[Y]={name:y,callback:v,note:U},g.onResolve.push({id:Y,filter:V.source,namespace:G||""})},onLoad(d,v){let M='This error came from the "onLoad" callback registered here',U=ke(new Error(M),e,"onLoad"),z={},V=n(d,z,"filter",Be),G=n(d,z,"namespace",p);if(K(d,z,`in onLoad() call for plugin ${JSON.stringify(y)}`),V==null)throw new Error("onLoad() call is missing a filter");let Y=O++;I[Y]={name:y,callback:v,note:U},g.onLoad.push({id:Y,filter:V.source,namespace:G||""})}});D&&await D,x.push(g)}catch(u){return{ok:!1,error:u,pluginName:y}}}const N=async S=>{switch(S.command){case"start":{let m={errors:[],warnings:[]};return await Promise.all(B.map(async({name:y,callback:u,note:g})=>{try{let D=await u();if(D!=null){if(typeof D!="object")throw new Error(`Expected onStart() callback in plugin ${JSON.stringify(y)} to return an object`);let d={},v=n(D,d,"errors",J),M=n(D,d,"warnings",J);K(D,d,`from onStart() callback in plugin ${JSON.stringify(y)}`),v!=null&&m.errors.push(...se(v,"errors",w,y)),M!=null&&m.warnings.push(...se(M,"warnings",w,y))}}catch(D){m.errors.push(we(D,e,w,g&&g(),y))}})),m}case"resolve":{let m={},y="",u,g;for(let D of S.ids)try{({name:y,callback:u,note:g}=T[D]);let d=await u({path:S.path,importer:S.importer,namespace:S.namespace,resolveDir:S.resolveDir,kind:S.kind,pluginData:w.load(S.pluginData)});if(d!=null){if(typeof d!="object")throw new Error(`Expected onResolve() callback in plugin ${JSON.stringify(y)} to return an object`);let v={},M=n(d,v,"pluginName",p),U=n(d,v,"path",p),z=n(d,v,"namespace",p),V=n(d,v,"external",W),G=n(d,v,"sideEffects",W),Y=n(d,v,"pluginData",De),le=n(d,v,"errors",J),ie=n(d,v,"warnings",J),A=n(d,v,"watchFiles",J),Q=n(d,v,"watchDirs",J);K(d,v,`from onResolve() callback in plugin ${JSON.stringify(y)}`),m.id=D,M!=null&&(m.pluginName=M),U!=null&&(m.path=U),z!=null&&(m.namespace=z),V!=null&&(m.external=V),G!=null&&(m.sideEffects=G),Y!=null&&(m.pluginData=w.store(Y)),le!=null&&(m.errors=se(le,"errors",w,y)),ie!=null&&(m.warnings=se(ie,"warnings",w,y)),A!=null&&(m.watchFiles=$e(A,"watchFiles")),Q!=null&&(m.watchDirs=$e(Q,"watchDirs"));break}}catch(d){return{id:D,errors:[we(d,e,w,g&&g(),y)]}}return m}case"load":{let m={},y="",u,g;for(let D of S.ids)try{({name:y,callback:u,note:g}=I[D]);let d=await u({path:S.path,namespace:S.namespace,pluginData:w.load(S.pluginData)});if(d!=null){if(typeof d!="object")throw new Error(`Expected onLoad() callback in plugin ${JSON.stringify(y)} to return an object`);let v={},M=n(d,v,"pluginName",p),U=n(d,v,"contents",tt),z=n(d,v,"resolveDir",p),V=n(d,v,"pluginData",De),G=n(d,v,"loader",p),Y=n(d,v,"errors",J),le=n(d,v,"warnings",J),ie=n(d,v,"watchFiles",J),A=n(d,v,"watchDirs",J);K(d,v,`from onLoad() callback in plugin ${JSON.stringify(y)}`),m.id=D,M!=null&&(m.pluginName=M),U instanceof Uint8Array?m.contents=U:U!=null&&(m.contents=fe(U)),z!=null&&(m.resolveDir=z),V!=null&&(m.pluginData=w.store(V)),G!=null&&(m.loader=G),Y!=null&&(m.errors=se(Y,"errors",w,y)),le!=null&&(m.warnings=se(le,"warnings",w,y)),ie!=null&&(m.watchFiles=$e(ie,"watchFiles")),A!=null&&(m.watchDirs=$e(A,"watchDirs"));break}}catch(d){return{id:D,errors:[we(d,e,w,g&&g(),y)]}}return m}default:throw new Error("Invalid command: "+S.command)}};let E=(S,m,y)=>y();C.length>0&&(E=(S,m,y)=>{(async()=>{for(const{name:u,callback:g,note:D}of C)try{await g(S)}catch(d){S.errors.push(await new Promise(v=>m(d,u,D&&D(),v)))}})().then(y)});let $=0;return{ok:!0,requestPlugins:x,runOnEndCallbacks:E,pluginRefs:{ref(){++$==1&&r.set(c,N)},unref(){--$==0&&r.delete(c)}}}},ae=(h,f,c)=>{let w={},B=n(f,w,"port",de),C=n(f,w,"host",p),T=n(f,w,"servedir",p),I=n(f,w,"onRequest",Le),O=l++,L,x=new Promise((N,E)=>{L=$=>{s.delete(O),$!==null?E(new Error($)):N()}});return c.serve={serveID:O},K(f,w,"in serve() call"),B!==void 0&&(c.serve.port=B),C!==void 0&&(c.serve.host=C),T!==void 0&&(c.serve.servedir=T),s.set(O,{onRequest:I,onWait:L}),{wait:x,stop(){R(h,{command:"serve-stop",serveID:O},()=>{})}}};const oe="warning",H="silent";let ve=h=>{let f=b++;const c=We();let w,{refs:B,options:C,isTTY:T,callback:I}=h;if(typeof C=="object"){let x=C.plugins;if(x!==void 0){if(!Array.isArray(x))throw new Error('"plugins" must be an array');w=x}}let O=(x,N,E,$)=>{let S=[];try{xe(S,C,{},T,oe)}catch{}const m=we(x,e,c,E,N);R(B,{command:"error",flags:S,error:m},()=>{m.detail=c.load(m.detail),$(m)})},L=(x,N)=>{O(x,N,void 0,E=>{I(me("Build failed",[E],[]),null)})};if(w&&w.length>0){if(e.isSync)return L(new Error("Cannot use plugins in synchronous API calls"),"");te(C,w,f,c).then(x=>{if(!x.ok)L(x.error,x.pluginName);else try{ye({...h,key:f,details:c,logPluginError:O,requestPlugins:x.requestPlugins,runOnEndCallbacks:x.runOnEndCallbacks,pluginRefs:x.pluginRefs})}catch(N){L(N,"")}},x=>L(x,""))}else try{ye({...h,key:f,details:c,logPluginError:O,requestPlugins:null,runOnEndCallbacks:(x,N,E)=>E(),pluginRefs:null})}catch(x){L(x,"")}},ye=({callName:h,refs:f,serveOptions:c,options:w,isTTY:B,defaultWD:C,callback:T,key:I,details:O,logPluginError:L,requestPlugins:x,runOnEndCallbacks:N,pluginRefs:E})=>{const $={ref(){E&&E.ref(),f&&f.ref()},unref(){E&&E.unref(),f&&f.unref()}};let S=!e.isBrowser,{entries:m,flags:y,write:u,stdinContents:g,stdinResolveDir:D,absWorkingDir:d,incremental:v,nodePaths:M,watch:U}=nt(h,w,B,oe,S),z={command:"build",key:I,entries:m,flags:y,write:u,stdinContents:g,stdinResolveDir:D,absWorkingDir:d||C,incremental:v,nodePaths:M};x&&(z.plugins=x);let V=c&&ae($,c,z),G,Y,le=(A,Q)=>{A.outputFiles&&(Q.outputFiles=A.outputFiles.map(at)),A.metafile&&(Q.metafile=JSON.parse(A.metafile)),A.writeToStdout!==void 0&&console.log(be(A.writeToStdout).replace(/\n$/,""))},ie=(A,Q)=>{let Z={errors:pe(A.errors,O),warnings:pe(A.warnings,O)};le(A,Z),N(Z,L,()=>{if(Z.errors.length>0)return Q(me("Build failed",Z.errors,Z.warnings),null);if(A.rebuildID!==void 0){if(!G){let ne=!1;G=()=>new Promise((ue,ce)=>{if(ne||o)throw new Error("Cannot rebuild");R($,{command:"rebuild",rebuildID:A.rebuildID},(q,Ye)=>{if(q)return Q(me("Build failed",[{pluginName:"",text:q,location:null,notes:[],detail:void 0}],[]),null);ie(Ye,(je,Ke)=>{je?ce(je):ue(Ke)})})}),$.ref(),G.dispose=()=>{ne||(ne=!0,R($,{command:"rebuild-dispose",rebuildID:A.rebuildID},()=>{}),$.unref())}}Z.rebuild=G}if(A.watchID!==void 0){if(!Y){let ne=!1;$.ref(),Y=()=>{ne||(ne=!0,i.delete(A.watchID),R($,{command:"watch-stop",watchID:A.watchID},()=>{}),$.unref())},U&&i.set(A.watchID,(ue,ce)=>{if(ue){U.onRebuild&&U.onRebuild(ue,null);return}let q={errors:pe(ce.errors,O),warnings:pe(ce.warnings,O)};le(ce,q),N(q,L,()=>{if(q.errors.length>0){U.onRebuild&&U.onRebuild(me("Build failed",q.errors,q.warnings),null);return}ce.rebuildID!==void 0&&(q.rebuild=G),q.stop=Y,U.onRebuild&&U.onRebuild(null,q)})})}Z.stop=Y}Q(null,Z)})};if(u&&e.isBrowser)throw new Error('Cannot enable "write" in the browser');if(v&&e.isSync)throw new Error('Cannot use "incremental" with a synchronous build');if(U&&e.isSync)throw new Error('Cannot use "watch" with a synchronous build');R($,z,(A,Q)=>{if(A)return T(new Error(A),null);if(V){let Z=Q,ne=!1;$.ref();let ue={port:Z.port,host:Z.host,wait:V.wait,stop(){ne||(ne=!0,V.stop(),$.unref())}};return $.ref(),V.wait.then($.unref,$.unref),T(null,ue)}return ie(Q,T)})};return{readFromStdout:F,afterClose:_,service:{buildOrServe:ve,transform:({callName:h,refs:f,input:c,options:w,isTTY:B,fs:C,callback:T})=>{const I=We();let O=L=>{try{if(typeof c!="string")throw new Error('The input to "transform" must be a string');let x=lt(h,w,B,H);R(f,{command:"transform",flags:x,inputFS:L!==null,input:L!==null?L:c},(E,$)=>{if(E)return T(new Error(E),null);let S=pe($.errors,I),m=pe($.warnings,I),y=1,u=()=>--y==0&&T(null,{warnings:m,code:$.code,map:$.map});if(S.length>0)return T(me("Transform failed",S,m),null);$.codeFS&&(y++,C.readFile($.code,(g,D)=>{g!==null?T(g,null):($.code=D,u())})),$.mapFS&&(y++,C.readFile($.map,(g,D)=>{g!==null?T(g,null):($.map=D,u())})),u()})}catch(x){let N=[];try{xe(N,w,{},B,H)}catch{}const E=we(x,e,I,void 0,"");R(f,{command:"error",flags:N,error:E},()=>{E.detail=I.load(E.detail),T(me("Transform failed",[E],[]),null)})}};if(typeof c=="string"&&c.length>1024*1024){let L=O;O=()=>C.writeFile(c,L)}O(null)},formatMessages:({callName:h,refs:f,messages:c,options:w,callback:B})=>{let C=se(c,"messages",null,"");if(!w)throw new Error(`Missing second argument in ${h}() call`);let T={},I=n(w,T,"kind",p),O=n(w,T,"color",W),L=n(w,T,"terminalWidth",de);if(K(w,T,`in ${h}() call`),I===void 0)throw new Error(`Missing "kind" in ${h}() call`);if(I!=="error"&&I!=="warning")throw new Error(`Expected "kind" to be "error" or "warning" in ${h}() call`);let x={command:"format-msgs",messages:C,isWarning:I==="warning"};O!==void 0&&(x.color=O),L!==void 0&&(x.terminalWidth=L),R(f,x,(N,E)=>{if(N)return B(new Error(N),null);B(null,E.messages)})}}}}function We(){const e=new Map;let t=0;return{load(r){return e.get(r)},store(r){if(r===void 0)return-1;const i=t++;return e.set(i,r),i}}}function ke(e,t,r){let i,s=!1;return()=>{if(s)return i;s=!0;try{let l=(e.stack+"").split(`
`);l.splice(1,1);let o=Je(t,l,r);if(o)return i={text:e.message,location:o},i}catch{}}}function we(e,t,r,i,s){let l="Internal error",o=null;try{l=(e&&e.message||e)+""}catch{}try{o=Je(t,(e.stack+"").split(`
`),"")}catch{}return{pluginName:s,text:l,location:o,notes:i?[i]:[],detail:r?r.store(e):-1}}function Je(e,t,r){let i="    at ";if(e.readFileSync&&!t[0].startsWith(i)&&t[1].startsWith(i))for(let s=1;s<t.length;s++){let l=t[s];if(!!l.startsWith(i))for(l=l.slice(i.length);;){let o=/^(?:new |async )?\S+ \((.*)\)$/.exec(l);if(o){l=o[1];continue}if(o=/^eval at \S+ \((.*)\)(?:, \S+:\d+:\d+)?$/.exec(l),o){l=o[1];continue}if(o=/^(\S+):(\d+):(\d+)$/.exec(l),o){let a;try{a=e.readFileSync(o[1],"utf8")}catch{break}let b=a.split(/\r\n|\r|\n|\u2028|\u2029/)[+o[2]-1]||"",k=+o[3]-1,j=b.slice(k,k+r.length)===r?r.length:0;return{file:o[1],namespace:"file",line:+o[2],column:fe(b.slice(0,k)).length,length:fe(b.slice(k,k+j)).length,lineText:b+`
`+t.slice(1).join(`
`),suggestion:""}}break}}return null}function me(e,t,r){let i=5,s=t.length<1?"":` with ${t.length} error${t.length<2?"":"s"}:`+t.slice(0,i+1).map((o,a)=>{if(a===i)return`
...`;if(!o.location)return`
error: ${o.text}`;let{file:b,line:k,column:j}=o.location,F=o.pluginName?`[plugin: ${o.pluginName}] `:"";return`
${b}:${k}:${j}: error: ${F}${o.text}`}).join(""),l=new Error(`${e}${s}`);return l.errors=t,l.warnings=r,l}function pe(e,t){for(const r of e)r.detail=t.load(r.detail);return e}function _e(e,t){if(e==null)return null;let r={},i=n(e,r,"file",p),s=n(e,r,"namespace",p),l=n(e,r,"line",de),o=n(e,r,"column",de),a=n(e,r,"length",de),b=n(e,r,"lineText",p),k=n(e,r,"suggestion",p);return K(e,r,t),{file:i||"",namespace:s||"",line:l||0,column:o||0,length:a||0,lineText:b||"",suggestion:k||""}}function se(e,t,r,i){let s=[],l=0;for(const o of e){let a={},b=n(o,a,"pluginName",p),k=n(o,a,"text",p),j=n(o,a,"location",Ue),F=n(o,a,"notes",J),_=n(o,a,"detail",De),R=`in element ${l} of "${t}"`;K(o,a,R);let P=[];if(F)for(const ee of F){let X={},re=n(ee,X,"text",p),te=n(ee,X,"location",Ue);K(ee,X,R),P.push({text:re||"",location:_e(te,R)})}s.push({pluginName:b||i,text:k||"",location:_e(j,R),notes:P,detail:r?r.store(_):-1}),l++}return s}function $e(e,t){const r=[];for(const i of e){if(typeof i!="string")throw new Error(`${JSON.stringify(t)} must be an array of strings`);r.push(i)}return r}function at({path:e,contents:t}){let r=null;return{path:e,contents:t,get text(){return r===null&&(r=be(t)),r}}}let ot=e=>st().build(e);const Tt=()=>{throw new Error('The "serve" API only works in node')},At=()=>{throw new Error('The "buildSync" API only works in node')},Ct=()=>{throw new Error('The "transformSync" API only works in node')},Nt=()=>{throw new Error('The "formatMessagesSync" API only works in node')};let ge,Fe,st=()=>{if(Fe)return Fe;throw ge?new Error('You need to wait for the promise returned from "initialize" to be resolved before calling this'):new Error('You need to call "initialize" before calling this')};const ut=e=>{e=rt(e||{});let t=e.wasmURL;const r=e.workerURL;let i=e.worker!==!1;if(!t)throw new Error('Must provide the "wasmURL" option');if(!r)throw new Error('Must provide the "workerURL" option');if(t+="",ge)throw new Error('Cannot call "initialize" more than once');return ge=ct(t,r,i),ge.catch(()=>{ge=void 0}),ge},ct=async(e,t,r)=>{let i=await fetch(e);if(!i.ok)throw new Error(`Failed to download ${JSON.stringify(e)}`);let s=await i.arrayBuffer(),l;if(r)l=new Worker(t);else{const b=await fetch(t);if(!b.ok)throw new Error(`Failed to download ${JSON.stringify(e)}`);let j=new Function("postMessage",await b.text()+"var onmessage; return m => onmessage(m)")(F=>l.onmessage({data:F}));l={onmessage:null,postMessage:F=>j({data:F}),terminate(){}}}l.postMessage(s),l.onmessage=({data:b})=>o(b);let{readFromStdout:o,service:a}=it({writeToStdin(b){l.postMessage(b)},isSync:!1,isBrowser:!0});Fe={build:b=>new Promise((k,j)=>a.buildOrServe({callName:"build",refs:null,serveOptions:null,options:b,isTTY:!1,defaultWD:"/",callback:(F,_)=>F?j(F):k(_)})),transform:(b,k)=>new Promise((j,F)=>a.transform({callName:"transform",refs:null,input:b,options:k||{},isTTY:!1,fs:{readFile(_,R){R(new Error("Internal error"),null)},writeFile(_,R){R(null)}},callback:(_,R)=>_?F(_):j(R)})),formatMessages:(b,k)=>new Promise((j,F)=>a.formatMessages({callName:"formatMessages",refs:null,messages:b,options:k,callback:(_,R)=>_?F(_):j(R)}))}};let ft="http-fetch",dt=({onResolve:e,onLoad:t})=>{e({filter:/^https:\/\//},ht),e({filter:/.*/,namespace:"http-fetch"},wt),t({filter:/.*/,namespace:"http-fetch"},mt)},ht=({path:e})=>({path:e,namespace:"http-fetch"}),wt=({path:e,importer:t})=>({path:new URL(e,t).href,namespace:"http-fetch"}),mt=async({path:e})=>{let t=await fetch(e);if(!t.ok){let a=`GET ${e} failed: status ${t.status}`;throw new Error(a)}let r=await t.text(),i=/\/\/# sourceMappingURL=(\S+)/,s=r.match(i);if(s){let a=new URL(s[1],t.url),k=`//# sourceMappingURL=${await pt(a)}`;r=r.replace(i,k)}let{pathname:l}=new URL(t.url),o=l.match(/[^.]+$/)[0];return{contents:r,loader:o}},pt=async e=>{let t=await fetch(e),r=t.headers.get("content-type").replace(/\s/g,""),i=await t.arrayBuffer(),s=new Blob([i],{type:r}),l=new FileReader;return new Promise(o=>{l.onload=a=>o(a.target.result),l.readAsDataURL(s)})};const gt={name:ft,setup:dt};let Te;async function yt(){return Te===void 0&&(Te=ut({wasmURL:"https://scrapbox.io/files/613405865f15ce002394c919.wasm",workerURL:"https://scrapbox.io/api/code/takker/esbuild-wasm@0.12.25/wasm_exec.js"})),await Te}function bt(e){return["ts","js","tsx","jsx","mjs","javascript","typescript"].includes(e)}async function vt(e,{extension:t,fileName:r,resolveDir:i}){await yt();const{outputFiles:s}=await ot({stdin:{contents:e,loader:xt(t),resolveDir:i,sourcefile:r},format:"esm",bundle:!0,minify:!0,charset:"utf8",plugins:[gt],write:!1});return s[0].text}function xt(e){switch(e){case"javascript":case"js":case"mjs":return"js";case"typescript":case"ts":return"ts";case"jsx":return"jsx";case"tsx":return"tsx"}}function kt(){const e=document.createElement("i");return e.classList.add("kamon","kamon-check-circle-fill"),e.style.color="hsl(133, 46.1%, 47.3%)",e}function $t(){const e=document.createElement("i");return e.classList.add("kamon","kamon-cross-circle"),e.style.color="hsl(1.7, 64.5%, 58%)",e}function Et(){const e=document.createElement("i");return e.classList.add("i","fa","fa-spinner"),e}function St(){const e=document.createElement("i");return e.classList.add("kamon","kamon-play"),e}function jt(){let e;return{show:(i,{x:s,y:l})=>{e=Rt(),e.append(Dt(i)),e.style.visibility="hidden",document.body.append(e);const{height:o}=e.getBoundingClientRect();e.style.top=`${l-o}px`,e.style.left=`${s}px`,e.style.removeProperty("visibility")},hide:async()=>{e?.classList?.remove?.("in"),await new Promise(i=>setTimeout(i,150)),e?.remove?.()}}}function Rt(){const e=document.createElement("div");return e.setAttribute("role","tooltip"),e.classList.add("fade","in","tooltip","top"),e}function Dt(e){const t=document.createElement("pre");return t.classList.add("tooltip-inner"),t.style.textAlign="unset",t.style.maxWidth="70vw",t.style.margin="unset",t.innerText=e,t}function Lt(){const e=document.createElement("a");e.classList.add("tool-btn"),e.type="button",e.setAttribute("aria-haspopup","true");let t=!1;const{show:r,hide:i}=jt();return{component:e,setStatus:async(l,o)=>{switch(e.textContent="",await i(),l){case"loading":e.append(Et());break;case"pass":e.append(kt());break;case"fail":e.append($t());break;case"none":break}o!==void 0&&l!=="none"?(e.style.removeProperty("pointer-events"),e.onclick=async()=>{if(t)await i();else{const{top:a,left:b}=e.getBoundingClientRect();r(o,{y:a+window.scrollY,x:b})}t=!t}):e.style.pointerEvents="none"}}}function Ot(e){const t=document.createElement("a");return t.classList.add("tool-btn"),t.type="button",t.setAttribute("aria-haspopup","true"),t.append(St()),t.addEventListener("click",e),t}function Ft(e){const{component:t,setStatus:r}=Lt(),i=document.createElement("div");return i.style.position="absolute",i.style.left="-2em",i.style.zIndex="1",i.style.display="flex",i.style.flexFlow="column",i.append(Ot(e),t),{menu:i,setStatus:r}}const ze=[],Ve=()=>{const e=He();ze.forEach(({menu:t,setStatus:r})=>{r("none"),t.remove()}),e.forEach(t=>{const r=t.lang.toLowerCase();!bt(r)||t.startIds.forEach(i=>{const s=document.getElementById(`L${i}`),{menu:l,setStatus:o}=Ft(async()=>{await o("loading");try{const a=await vt(t.lines.join(`
`),{extension:r,fileName:t.filename,resolveDir:t.dir});console.log("execute:",a),await Function(`return (async()=>{${a}})()`)(),await o("pass")}catch(a){await o("fail",a.toString())}});ze.push({menu:l,setStatus:o}),s?.insertBefore?.(l,s?.firstElementChild)})})};Ve(),scrapbox.addListener("lines:changed",Ve);
